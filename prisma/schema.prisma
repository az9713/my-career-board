// PCGS Database Schema - SQLite with Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User account for authentication
model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  password                String
  name                    String?
  avatarUrl               String?
  settings                String    @default("{\"llm_provider\": \"anthropic\", \"notifications_enabled\": true}")
  timezone                String    @default("UTC")
  notificationPreferences String?   // JSON with email preferences
  notificationEmail       String?   // Override email for notifications
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  problems      Problem[]
  boardRoles    BoardRole[]
  boardSessions BoardSession[]
  reports       QuarterlyReport[]
  bets          Bet[]
  reminders     Reminder[]
}

// Problem Portfolio
model Problem {
  id                      String   @id @default(cuid())
  userId                  String
  name                    String
  whatBreaks              String
  scarcitySignals         String   @default("[]")
  aiCheaper               String?
  errorCost               String?
  trustRequired           String?
  classification          String
  classificationReasoning String?
  timeAllocation          Int?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  boardRoles BoardRole[]

  @@index([userId])
}

// Board Roles
model BoardRole {
  id                String   @id @default(cuid())
  userId            String
  roleType          String
  anchoredProblemId String?
  focusArea         String
  systemPrompt      String?
  generatedAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  anchoredProblem Problem? @relation(fields: [anchoredProblemId], references: [id], onDelete: SetNull)

  @@index([userId])
}

// Board Sessions
model BoardSession {
  id           String    @id @default(cuid())
  userId       String
  sessionType  String
  quarter      String?
  status       String    @default("in_progress")
  currentPhase Int       @default(1)
  startedAt    DateTime  @default(now())
  completedAt  DateTime?

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages SessionMessage[]
  report   QuarterlyReport?

  @@index([userId])
  @@index([status])
}

// Session Messages
model SessionMessage {
  id          String   @id @default(cuid())
  sessionId   String
  speaker     String
  content     String
  messageType String
  metadata    String?
  createdAt   DateTime @default(now())

  session BoardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Quarterly Reports
model QuarterlyReport {
  id        String @id @default(cuid())
  sessionId String @unique
  userId    String
  quarter   String

  lastBet         String?
  lastBetWrongIf  String?
  lastBetResult   String?
  lastBetEvidence String?
  commitments     String?

  avoidedDecision     String
  avoidedDecisionWhy  String
  avoidedDecisionCost String
  comfortWork         String
  comfortWorkAvoided  String

  nextBet        String
  nextBetWrongIf String

  overallAssessment String?
  concerns          String?
  actionItems       String?

  createdAt DateTime @default(now())

  session BoardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Bets - Falsifiable commitments for accountability tracking
model Bet {
  id                  String    @id @default(cuid())
  userId              String
  content             String    // The bet statement
  falsifiableCriteria String    // How to determine if bet was hit or missed
  deadline            DateTime  // When the bet should be evaluated
  quarter             String    // e.g., "Q1-2024"
  status              String    @default("pending") // pending, resolved
  outcome             String?   // hit, miss, excused
  evidence            String?   // Proof if bet was hit
  reflection          String?   // Reflection if bet was missed or excused
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  resolvedAt          DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quarter])
  @@index([status])
}

// Reminders - Scheduled notifications for users
model Reminder {
  id           String    @id @default(cuid())
  userId       String
  type         String    // quarterly_review, weekly_checkin, avoidance_alert, streak_milestone
  scheduledFor DateTime  // When to send the reminder
  sent         Boolean   @default(false)
  sentAt       DateTime?
  metadata     String?   // JSON with additional context
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledFor])
  @@index([sent])
  @@index([type])
}
