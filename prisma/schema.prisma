// PCGS Database Schema - SQLite with Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User account for authentication
model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  password                String
  name                    String?
  avatarUrl               String?
  settings                String    @default("{\"llm_provider\": \"anthropic\", \"notifications_enabled\": true}")
  timezone                String    @default("UTC")
  notificationPreferences String?   // JSON with email preferences
  notificationEmail       String?   // Override email for notifications
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  problems       Problem[]
  boardRoles     BoardRole[]
  boardSessions  BoardSession[]
  reports        QuarterlyReport[]
  bets           Bet[]
  reminders      Reminder[]
  contexts       UserContext[]
  accounts       Account[]
  calendarEvents CalendarEvent[]
  teamMembers    TeamMember[]
  teamInvitesSent TeamInvite[]   @relation("InvitedBy")
  feedbackGiven  PeerFeedback[] @relation("FeedbackFrom")
  feedbackReceived PeerFeedback[] @relation("FeedbackTo")
  evidence       Evidence[]
  checkins       MicroCheckin[]
  checkinStreak  CheckinStreak?
}

// Problem Portfolio
model Problem {
  id                      String   @id @default(cuid())
  userId                  String
  name                    String
  whatBreaks              String
  scarcitySignals         String   @default("[]")
  aiCheaper               String?
  errorCost               String?
  trustRequired           String?
  classification          String
  classificationReasoning String?
  timeAllocation          Int?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  boardRoles BoardRole[]

  @@index([userId])
}

// Board Roles
model BoardRole {
  id                String   @id @default(cuid())
  userId            String
  roleType          String
  anchoredProblemId String?
  focusArea         String
  systemPrompt      String?
  generatedAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  anchoredProblem Problem? @relation(fields: [anchoredProblemId], references: [id], onDelete: SetNull)

  @@index([userId])
}

// Board Sessions
model BoardSession {
  id           String    @id @default(cuid())
  userId       String
  sessionType  String
  quarter      String?
  status       String    @default("in_progress")
  currentPhase Int       @default(1)
  startedAt    DateTime  @default(now())
  completedAt  DateTime?

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages SessionMessage[]
  report   QuarterlyReport?

  @@index([userId])
  @@index([status])
}

// Session Messages
model SessionMessage {
  id          String   @id @default(cuid())
  sessionId   String
  speaker     String
  content     String
  messageType String
  metadata    String?
  createdAt   DateTime @default(now())

  session BoardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

// Quarterly Reports
model QuarterlyReport {
  id        String @id @default(cuid())
  sessionId String @unique
  userId    String
  quarter   String

  lastBet         String?
  lastBetWrongIf  String?
  lastBetResult   String?
  lastBetEvidence String?
  commitments     String?

  avoidedDecision     String
  avoidedDecisionWhy  String
  avoidedDecisionCost String
  comfortWork         String
  comfortWorkAvoided  String

  nextBet        String
  nextBetWrongIf String

  overallAssessment String?
  concerns          String?
  actionItems       String?

  createdAt DateTime @default(now())

  session BoardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Bets - Falsifiable commitments for accountability tracking
model Bet {
  id                  String    @id @default(cuid())
  userId              String
  content             String    // The bet statement
  falsifiableCriteria String    // How to determine if bet was hit or missed
  deadline            DateTime  // When the bet should be evaluated
  quarter             String    // e.g., "Q1-2024"
  status              String    @default("pending") // pending, resolved
  outcome             String?   // hit, miss, excused
  evidence            String?   // Proof if bet was hit
  reflection          String?   // Reflection if bet was missed or excused
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  resolvedAt          DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quarter])
  @@index([status])
}

// Reminders - Scheduled notifications for users
model Reminder {
  id           String    @id @default(cuid())
  userId       String
  type         String    // quarterly_review, weekly_checkin, avoidance_alert, streak_milestone
  scheduledFor DateTime  // When to send the reminder
  sent         Boolean   @default(false)
  sentAt       DateTime?
  metadata     String?   // JSON with additional context
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledFor])
  @@index([sent])
  @@index([type])
}

// User Context - Personal context for AI directors
model UserContext {
  id         String   @id @default(cuid())
  userId     String
  type       String   // resume, linkedin, document, notes
  name       String   // User-defined name for this context
  rawText    String?  // Original text content
  parsedData String?  // JSON with extracted structured data
  summary    String?  // AI-generated summary for director prompts
  metadata   String?  // JSON with file info, source, etc.
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

// Account - OAuth and other authentication providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String  // oauth, credentials
  provider          String  // google, github, credentials
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// CalendarEvent - Scheduled meetings and reminders
model CalendarEvent {
  id               String    @id @default(cuid())
  userId           String
  title            String
  description      String?
  type             String    // quarterly_review, weekly_checkin, bet_deadline, custom
  startTime        DateTime
  endTime          DateTime
  reminders        String?   // JSON array of minutes before event
  externalId       String?   // ID from external calendar (Google, etc.)
  externalProvider String?   // google, outlook, etc.
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startTime])
  @@index([type])
}

// Team - Accountability groups
model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members  TeamMember[]
  invites  TeamInvite[]
  feedback PeerFeedback[]
}

// TeamMember - Team membership with roles
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("member") // owner, admin, member
  joinedAt  DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// TeamInvite - Pending team invitations
model TeamInvite {
  id          String   @id @default(cuid())
  teamId      String
  email       String
  invitedById String
  status      String   @default("pending") // pending, accepted, declined
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team      Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  invitedBy User @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([email])
  @@index([status])
}

// PeerFeedback - Feedback between team members
model PeerFeedback {
  id         String   @id @default(cuid())
  teamId     String
  fromUserId String
  toUserId   String
  type       String   // encouragement, suggestion, concern, celebration
  content    String
  createdAt  DateTime @default(now())

  team     Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  fromUser User @relation("FeedbackFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User @relation("FeedbackTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([toUserId])
}

// Evidence Vault - Document accomplishments and feedback
model Evidence {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  type        String   // win, feedback, metric, artifact, milestone
  source      String?  // performance-review, self, manager, peer, customer
  date        DateTime @default(now())
  impact      String?  // Description of the impact
  metadata    String?  // JSON with additional context
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  attachments EvidenceAttachment[]
  problemLinks EvidenceProblemLink[]

  @@index([userId])
  @@index([type])
  @@index([date])
}

// EvidenceAttachment - Files attached to evidence
model EvidenceAttachment {
  id         String   @id @default(cuid())
  evidenceId String
  filename   String
  fileType   String   // pdf, image, document, etc.
  url        String   // Storage URL or path
  size       Int?     // File size in bytes
  createdAt  DateTime @default(now())

  evidence Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@index([evidenceId])
}

// EvidenceProblemLink - Link evidence to portfolio problems
model EvidenceProblemLink {
  id         String @id @default(cuid())
  evidenceId String
  problemId  String

  evidence Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@unique([evidenceId, problemId])
  @@index([evidenceId])
  @@index([problemId])
}

// MicroCheckin - Lightweight daily/weekly check-ins
model MicroCheckin {
  id        String   @id @default(cuid())
  userId    String
  promptId  String
  response  String
  mood      Int?     // 1-5 scale
  createdAt DateTime @default(now())

  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  prompt CheckinPrompt @relation(fields: [promptId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

// CheckinPrompt - Questions for check-ins
model CheckinPrompt {
  id        String   @id @default(cuid())
  category  String   // progress, blockers, wins, reflection, planning
  question  String
  frequency String   @default("daily") // daily, weekly
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  checkins MicroCheckin[]

  @@index([category])
  @@index([frequency])
  @@index([isActive])
}

// CheckinStreak - Track user check-in streaks
model CheckinStreak {
  id            String    @id @default(cuid())
  userId        String    @unique
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastCheckinAt DateTime?
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
